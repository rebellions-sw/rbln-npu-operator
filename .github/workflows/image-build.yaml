name: NPU Operator Image Build

on:
  workflow_call:
    inputs:
      push-on-build:
        description: "Whether to push image after build"
        required: false
        default: 'false'
        type: string
    outputs:
      operator-version:
        description: "Short commit SHA used for the operator image tag"
        value: ${{ jobs.build-npu-operator-build-amd64.outputs.operator-version }}
      operator-image-tag:
        description: "Full operator image tag (including architecture suffix)"
        value: ${{ jobs.build-npu-operator-build-amd64.outputs.operator-image-tag }}

jobs:
  build-npu-operator-build-amd64:
    name: build operator image
    runs-on: ubuntu-latest-rbln
    outputs:
      operator-version: ${{ steps.build_vars.outputs.commit_short_sha }}
      operator-image-tag: ${{ steps.build_vars.outputs.image_tag }}
    steps:
      - uses: actions/checkout@v4
        name: Checkout code
      - name: Define variable to build
        id: build_vars
        run: |
          COMMIT_SHORT_SHA=${GITHUB_SHA:0:8}
          IMAGE_TAG="${COMMIT_SHORT_SHA}-amd64"
          echo "COMMIT_SHORT_SHA=${COMMIT_SHORT_SHA}" >> $GITHUB_ENV
          echo "PUSH_ON_BUILD=${{ inputs.push-on-build }}" >> $GITHUB_ENV
          {
            echo "commit_short_sha=${COMMIT_SHORT_SHA}"
            echo "image_tag=${IMAGE_TAG}"
          } >> $GITHUB_OUTPUT
      - name: Set up Docker buildx
        uses: docker/setup-buildx-action@v3
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}
      - name: Build NPU operator image
        env:
          VERSION: ${{ steps.build_vars.outputs.image_tag }}
          PUSH_ON_BUILD: ${{ env.PUSH_ON_BUILD }}
        run: make build-image
