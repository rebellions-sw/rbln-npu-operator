name: Release Draft Pipeline

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-and-push-image:
    name: Build and push multi-arch image
    runs-on: ubuntu-latest-rbln
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Docker buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          registry: docker.io
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      - name: Build and push images
        env:
          VERSION: ${{ github.ref_name }}
          REGISTRY: docker.io/rebellions
          PUSH_ON_BUILD: "true"
          BUILD_MULTI_PLATFORM: "false" # TODO(mskim): revert when dedicated ARM runners become available
        run: make build-image
      - name: Build and push validator image
        env:
          VERSION: ${{ github.ref_name }}
          REGISTRY: docker.io/rebellions
          PUSH_ON_BUILD: "true"
          BUILD_MULTI_PLATFORM: "false" # TODO(mskim): revert when dedicated ARM runners become available
        run: make build-image IMAGE_NAME="${REGISTRY}/rbln-npu-operator-validator"

  package-helm-chart:
    name: Package Helm chart
    runs-on: ubuntu-latest-rbln
    steps:
      - uses: actions/checkout@v4
      - uses: azure/setup-helm@v4
        with:
          version: latest
      - name: Prepare chart dependencies
        run: |
          helm repo add nfd https://kubernetes-sigs.github.io/node-feature-discovery/charts
          helm dependency build deployments/rbln-npu-operator
      - name: Package chart
        env:
          TAG: ${{ github.ref_name }}
        run: |
          set -euo pipefail
          VERSION="${TAG#v}"
          mkdir -p dist
          helm package deployments/rbln-npu-operator \
            --destination dist \
            --version "$VERSION" \
            --app-version "$TAG"
      - name: Upload chart artifact
        uses: actions/upload-artifact@v4
        with:
          name: helm-chart-${{ github.ref_name }}
          path: dist/*.tgz

  draft-release:
    needs:
      - build-and-push-image
      - package-helm-chart
    runs-on: ubuntu-latest-rbln
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get previous tag
        id: prev
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 $(git rev-list --tags --skip=1 --max-count=1) 2>/dev/null || echo "")
          echo "previous_tag=$PREV_TAG" >> $GITHUB_ENV
          echo "Previous tag: $PREV_TAG"

      - name: Generate release notes
        run: |
          CURRENT_TAG=${GITHUB_REF_NAME}
          PREV_TAG=${previous_tag:-}
          REPO="${GITHUB_REPOSITORY}"

          if [ -n "$PREV_TAG" ]; then
            RANGE="$PREV_TAG..$CURRENT_TAG"
          else
            RANGE="$CURRENT_TAG"
          fi

          git log $RANGE --pretty=format:"%s ([%h](https://github.com/${REPO}/commit/%H))" \
            | sed -E "s|\(#([0-9]+)\)|([#\1](https://github.com/${REPO}/pull/\1))|g" \
            > commits.txt

          get_commits() { grep -E "^$1(\(.*\))?:" commits.txt || true; }

          FEATS=$(get_commits "feat")
          FIXES=$(get_commits "fix")
          DOCS=$(get_commits "docs")
          REFACTORS=$(get_commits "refactor")
          PERFS=$(get_commits "perf")
          STYLES=$(get_commits "style")
          BUILDS=$(get_commits "build")
          CHORES=$(get_commits "chore")
          TESTS=$(get_commits "test")

          {
            echo "# Release Notes"
            echo
            echo "## New Features"
            if [ -n "$FEATS" ]; then
              echo "$FEATS" | sed 's/^/- /'
            else
              echo "- TBD"
            fi
            echo

            echo "## Improvements"
            IMPROVEMENTS=0

            for GROUP in "$DOCS" "$REFACTORS" "$PERFS" "$STYLES" "$BUILDS" "$CHORES" "$TESTS"; do
              if [ -n "$GROUP" ]; then
                IMPROVEMENTS=1
              fi
            done

            if [ $IMPROVEMENTS -eq 1 ]; then
              [ -n "$DOCS" ] && echo "$DOCS" | sed 's/^/- /'
              [ -n "$REFACTORS" ] && echo "$REFACTORS" | sed 's/^/- /'
              [ -n "$PERFS" ] && echo "$PERFS" | sed 's/^/- /'
              [ -n "$STYLES" ] && echo "$STYLES" | sed 's/^/- /'
              [ -n "$BUILDS" ] && echo "$BUILDS" | sed 's/^/- /'
              [ -n "$CHORES" ] && echo "$CHORES" | sed 's/^/- /'
              [ -n "$TESTS" ] && echo "$TESTS" | sed 's/^/- /'
            else
              echo "- TBD"
            fi
            echo

            echo "## Fixed Issues"
            if [ -n "$FIXES" ]; then
              echo "$FIXES" | sed 's/^/- /'
            else
              echo "- TBD"
            fi
            echo

            echo "## Known Issues"
            echo "- TBD"
            echo
            echo "_This draft was auto-generated for tag: ${CURRENT_TAG}_"
          } > release_notes.md

      - name: Download Helm chart artifact
        uses: actions/download-artifact@v4
        with:
          name: helm-chart-${{ github.ref_name }}
          path: dist

      - name: Create draft release
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          tag_name: ${{ github.ref_name }}
          name: "RBLN NPU Operator ${{ github.ref_name }} Release "
          body_path: release_notes.md
          files: dist/*.tgz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
