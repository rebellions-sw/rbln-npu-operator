name: CI

on:
  push:
    branches:
      - main

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

jobs:
  manifests-check:
    uses: ./.github/workflows/manifests-check.yaml
  code-check:
    uses: ./.github/workflows/go-checks.yaml
  go-tests:
    uses: ./.github/workflows/go-tests.yaml
  go-build:
    uses: ./.github/workflows/go-build.yaml
  image-build:
    needs: [manifests-check, code-check, go-tests, go-build]
    uses: ./.github/workflows/image-build.yaml
    with:
      push-on-build: 'true'
      image-tag: latest
    secrets: inherit
