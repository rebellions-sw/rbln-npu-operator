name: PR Validation

on:
  pull_request:
    branches:
      - main

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

permissions:
  contents: read
  pull-requests: write
  statuses: write

jobs:
  pr-title-validation:
    runs-on: ubuntu-latest-rbln
    steps:
      - name: Validate PR title
        uses: amannn/action-semantic-pull-request@v5
        with:
          types: |
            build
            chore
            ci
            docs
            feat
            fix
            perf
            refactor
            revert
            style
            test
          scopes: |
            .*
          requireScope: false
          subjectPattern: ^.{1,100}$
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  manifests-check:
    needs: pr-title-validation
    uses: ./.github/workflows/manifests-check.yaml
  code-check:
    needs: pr-title-validation
    uses: ./.github/workflows/go-checks.yaml
  go-tests:
    needs: pr-title-validation
    uses: ./.github/workflows/go-tests.yaml
  go-build:
    needs: pr-title-validation
    uses: ./.github/workflows/go-build.yaml
  image-build:
    needs: [manifests-check, code-check, go-tests, go-build]
    uses: ./.github/workflows/image-build.yaml
    with:
      push-on-build: 'true'
    secrets: inherit
  e2e-tests:
    needs: [image-build]
    runs-on: sw-k8s-4c-32gb
    container:
      image: "ubuntu:24.04"
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Install make
        run: |
          apt-get update
          apt-get install -y make ca-certificates
          update-ca-certificates
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
      - name: Restore kubeconfig for e2e tests
        env:
          KUBECONFIG_B64: ${{ secrets.E2E_KUBECONFIG_B64 }}
        run: |
          if [ -z "$KUBECONFIG_B64" ]; then
            echo "E2E_KUBECONFIG_B64 secret is not configured" >&2
            exit 1
          fi
          KUBECONFIG_PATH="$RUNNER_TEMP/e2e-kubeconfig"
          printf '%s' "$KUBECONFIG_B64" | base64 --decode > "$KUBECONFIG_PATH"
          chmod 600 "$KUBECONFIG_PATH"
          echo "KUBECONFIG=$KUBECONFIG_PATH" >> $GITHUB_ENV
      - name: Run e2e tests
        env:
          KUBE_CONTEXT: ${{ secrets.E2E_KUBE_CONTEXT }}
          OPERATOR_VERSION: ${{ needs.image-build.outputs.operator-image-tag }}
          PYPI_USERNAME: ${{ secrets.E2E_PYPI_USERNAME }}
          PYPI_PASSWORD: ${{ secrets.E2E_PYPI_PASSWORD }}
        run: |
          make -C test/e2e e2e-test
